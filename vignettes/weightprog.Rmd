---
title: "weightprog"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{weightprog}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---
## Introduction

In this vignette, we will demonstrate how to use the package, `weightprog`. This package will use data from the smartphone "Pillow" and "Health" app that provides sleep cycle and activity level statistics. The objective of the package is to allow for easy visualization and analysis for comparisons of any statistical changes in our focused variable over a time period. Specifically, the package's illustrations include a multitude of two-way graphs that evaluate the underlying trend in different ways. Each different type of analysis will be described in the following secctions.  

## Description

When provided with weight changes along with data on sleep cycle and activity levels, the conventional analysis resorts to regression and t-test analysis. In fact, current type of analysis provides graphics through scatterplots that tend to provide minimal information. Instead, to assess the progressions of weight, we developed `weightprog` which specifically provides analysis through visualization by introducing a third variable, known as our objective variable, and presenting progressions of our objective variable without needing to refer to a three dimensional graph.

In fact, to understand where weight fluctuations stem from, we specifically track any weight changes while simultaneously keeping track of daily activities such as walking and sleep cycles. In addition, to fully comprehend whether activity and sleep levels are associated with daily weight changes, `weightprog` uses multiple graphical estimators. For starters, the visualization graphics, embeds ggplots that specifically uses color and sizes as an aid to enhance basic two way graphs. Such basic twoway graphs include scatterplots, lineplots, and strip plots that help estimate the changes in weight by color categorization for any relationship between two variables. For more in depth analysis, visualization graphics specifically aim to observe distinctions between groups through pattern recognition. The inclusion of cluster and linear discriminant analysis provide different types of data categorization that allow us to recognize specific trends in the data the basic twoway graphs fails to capture. From manipulation of size and color to concrete identification in data, these types of visualizations will allow the attributes of a third variable to be assessed while contained in a two-dimensional graph. 

For a more in-depth explanation of the data set, please refer to the Usage section. 

## Usage

There will be one primary data set that will be included in the package. The data includes an individual's weight progression with data on sleep cycles (i.e. hours of sleep, percent in deep sleep, etc.) and natural daily exercises (i.e. distance walked, steps in a day). The specific focus is on daily progression of weight, thus, the marginal change in weight from one day to the next will be the focal point of all visualization and analysis. First, we will load the package and the data. The data is imported from a publicized google document sheet. 

```{r }
library('weightprog')
```

```{r, eval=TRUE, message=FALSE}
library("googlesheets")
mykey <- gs_url("https://docs.google.com/spreadsheets/d/10KwAd2PL4FXbNrWkhLstzeuKvR9NYhfvegtPdjfELcM/edit?usp=sharing", lookup=FALSE, visibility = "public")
hello <- gs_read(mykey)
```

Before proceeding with the visualizations, we will first need to find a presentable objective variable that will be the focal point of our statistical analysis. The objective variable chosen for the package is the marginal weight change from one day to the next. To determine the relative size of such changes, we will take the absolute value of the marginal weight change, and also determine whether such changes were a loss, gain, or maintain in weight. There will be further explanation on what we mean by objective variable when we introduce the data in the package.

### Add Absolute Weight and Weight Change Groups 
```{r}
hello$absmargweight <- abs(hello$Marginal_Weight)
hello$posnegmarg <- c("Loss","Maintain","Gain")[sign(hello$Marginal_Weight)+2]
colnames(hello)[colnames(hello)=="absmargweight"] <- "Marginal_Change"
colnames(hello)[colnames(hello)=="posnegmarg"] <- "Class"
```

We will also have to change the format of the date in order to fit the needs of our visualization functions along with organizing the days of the week to follow the sequential order. This is a quick fix:

### Changing Format of Date and Organizing Days of Week
```{r}
dd = as.Date(hello$Date, format = "%m/%d/%Y")
hello$Day <- factor(hello$Day, levels=c("Monday", "Tuesday", 
                                        "Wednesday", "Thursday", 
                                        "Friday", "Saturday", "Sunday"))
```

## Introduction to Package Data 

Before introducing the functions in the package, let's take a closer look at the data that is built into the package. Since the statistics consist of activity, measured only by distance walked, functions will always use distance as the primary measurement. As for the sleep cycle, there are numerous categories of categories, and to take look at what each of the categories mean, we will first look at the summarization of the means for our sleep cycle statistics. For each statistic: Time_Asleep is hours asleep, Time_Bed is hours in bed, Time_Deep is hours in deep sleep, Time_Light is hours in light sleep, and Time_Sleep is hours till asleep. Since the mean does not tell us much about which category can be used as a primary measurement, we can proceed to using a linear regression and ANOVA. 

```{r, warning=FALSE, echo=FALSE}
library(tidyverse)
```
```{r}
library(tidyr)
base <- hello %>%
  mutate(Time_Deep = Deep_Sleep * Time_Asleep / 100) %>%
  mutate(Time_Light = Light_Sleep * Time_Asleep / 100) %>% 
  select("Day", "Time_Bed", "Time_Asleep", "Time_Sleep", "Time_Deep", "Time_Light") 
base <- gather(base, Time_Asleep, value, -Day) %>% 
        setNames(., c("Day", "Time", "value")) 

ggplot(base, aes(Day, value)) +   
geom_bar(aes(fill = Time), position = "dodge", stat="identity") +
xlab("Day of Week") + ylab("Hours") +
theme(axis.text.x=element_text(angle=45,hjust=1))
```

### Choosing our Primary Variables

With plenty of variables that seem to overlap and express similar characteristics, we will specifically run a multiple regression of marginal weight change on the distance, time asleep, and time in deep sleep and light sleep. When we run a linear model through these variables, the only significant variable is that of the time in deep sleep. Hence, we will specifically use deep sleep as our primary measurement for our sleep cycle (occasionally, we will use time asleep because it is a more general measurement). Likewise, when we run an ANOVA on the change in weight with variables of distance walked (measuring activity level) and time in deep sleep (measuring sleep cycle), we observe that deep sleep is on the borderline of being a statistically significant variable. Therefore, there is convincing evidence of a statistically significant difference in the time of deep sleep amongst changes in weight. Therefore, the two primary measurements that will be utilized will be distance for activity level, and deep sleep (can be in either hours or percentage), along with the occasional use of time asleep as a more general measurement. (Note: For future changes, we will will surpress the output for the linear regression and ANOVA.)

```{r}
base2 <- hello %>%
  mutate(Time_Deep = Deep_Sleep * Time_Asleep / 100) %>%
  mutate(Time_Light = Light_Sleep * Time_Asleep / 100) %>% 
  select("Distance","Time_Bed", "Time_Asleep", "Time_Deep", "Time_Light", "Marginal_Weight") 

fit <- lm(Marginal_Weight ~ Distance + Time_Asleep + Time_Deep + Time_Light + Time_Bed, data=base2)
summary(fit) # show results

weightprog1 = aov(Marginal_Weight ~ Distance*Time_Deep, data = base2)
summary(weightprog1)
```

### Understanding the Objective Variable

With the primary variables chosen to represent activity level and sleep cycle, we can now shift our focus to seeing if specific characteristics in distance and time in deep sleep seem to result in some type of pattern for the changes in weight. In this case, the variable of focus will be called the objective variable, consisting of the marginal changes in weight, with subgroups (called Class) of "Gain", "Loss", and "Maintain" in weight. Here is a scatterplot that shows a general overview of the two primary variables by the objective variable's subgroups: 

```{r}
intro <- hello %>%
  mutate(Time_Deep = Deep_Sleep * Time_Asleep / 100) %>%
  select("Distance", "Time_Deep", "Class") %>% ggplot(aes(x=Distance, y=Time_Deep, col = Class)) +
  geom_point() + xlab("Distance (km)") + ylab("Time in Deep Sleep (hrs)") +
  facet_wrap(~Class , ncol=1, scales="fixed", strip.position="right")
intro
```

Once we have gotten a better understanding of the built-in dataset in the package, we may proceed to the Experimental Design utilizing these variables. 


## Experimental Design

As mentioned previously above in the introduction to the data, we specifically look at how varying activity and sleep levels affect any weight changes over time. We will collect data by utilizing the "Health" application on the iPhone, which will automatically track the number of steps and distance walked today, along with the "Pillow" application that will track various sleep variables. To track any weight changes, a standard weighing scale will be used in order to weigh myself every morning after waking up.

With this type of experimental design, we see that there may be a low level of reliability in the data. Specifically, the measurement from the applications are by no means accurate, because it may not be an well-validated reflection of distance and sleep, but it is the closest we can get given that the phone application is only a tool of estimating our variables. This provides us the closest way to see whether or not distance walked, and sleep patterns play a role in any possible weight changes when limiting the observations to daily activities. However, we would have liked to include even more information that would have helped provide an even more convincing case for weight changes over time. Out of the many confounders, there exists confounders such as food intake (i.e calories) and exercise outside of walking that are not captured in the data. These potential confounders are very likely to play a role in weight changes. Since there is practically no aspect of the experiment that involves any treatment, we cannot blind or randomize anything without the participant (myself) knowing.  

## Example Features

### Two Way Scatter Feature

There are two different graphs within the two way scatter feature, twoway_scatterg(), and twoway_scatterc(). Both of these functions utilize a simple scatter plot between two variables of interest, and adds an additional layer for the objective variable. The two way scatter of objective variable by groups is the first of two functions, specifically aimed at using the objective variable's data points' color and size to provide information about the attributes. In addition, it runs a linear model through the specific subgroups of the objective variable. Meanwhile, the latter of the two functions, two way scatter by color, only displays any statistical changes in the objective variable through a sequential color palette. 

```{r, messages=FALSE}
library(ggplot2)
```

```{r, eval=TRUE}
#source('/Users/Benjamin Hsu/Desktop/weightprog/R/twoway_scatter.R')
tws_plot <- twoway_scatterg(hello, hello$Distance, hello$Time_Asleep,
                            hello$Marginal_Change, hello$Class,
                            "Distance Walked (km)", "Time Asleep (hrs)", 
                            "Change in Weight", "Class")
tws_plot
tws_plot2 <- twoway_scatterc(hello, hello$Time_Asleep, hello$Deep_Sleep,
                  hello$Marginal_Weight, 16, 3,
                  "Time Asleep (hrs)", "Deep Sleep (%)",
                  "Change in Weight")
tws_plot2
```

For the data inside the package, the objective variable is the marginal weight, specifically focused on the magnitude (size) of the change in marginal weight, and whether or not such changes were gain, loss or maintain in weight (color). Both scatter plots have the base scatterplot, for twoway_scatterg(), it was Time Asleep vs. Distance Walked, and for twoway_scatterc(), it was %Deep Sleep vs. Time Asleep. 

The speculation for the grouped scatter plot was that the more distance walked during the day, the more sleep an individual will need. For the two way scatter of the objective variable by groups, the two subgroups of gain and loss in weight showed a poor linear fit. Meanwhie, the maintain in weight saw a good linear fit. For the two way scatter of the objective variable by color, the speculation here was that more hrs of sleep might be because of a higher proportion of deeper sleep, and thus, possible gain in weight (assuming sleeping is minimal activity). The general pattern consists of losses in weight (green) in the lower left corner, which denotes less hours of sleep and less deep sleep, and the gains in weight (red) in the upper left corner denotes less hours of sleep and greater sleep. Both these scatterplots result in interesting conclusions, but as more data is included into the package, then a more conclusive result can be deduced. 

### Two Way Strip Plot

The strip plot is similar to the simplified two way scatter plot, because the points' color denotes the attribute (i.e. day of the week, species, etc.) of y variable chosen. The strip plot provides a better overview of the data's patterns within a subgroup, while also providing a lineplot of the estimate mean of each group. 

```{r, eval=TRUE}
#source('/Users/Benjamin Hsu/Desktop/weightprog/R/twoway_strip.R')
twoway_strip(hello, hello$Day, hello$Distance, " ", 
             hello$Day, "Day of Week", "Distance Walked (km)")
```

There was speculation that for different days of the week, an individual might be walked farther in distance, which might inherently mean that the activity level from one day to another differ. With different activity levels, it would be possible that this could affect the individual's marginal changes in weight. In the data, we specifically looked at the individual's activity level measured by distance walked in kilometers depending on the day of the week. We specifically see that the mean of distance walked seem to be on Monday and Friday, while the weekends seem to have significantly lower activity levels. 

### Two Way Lineplot

There are two different two way lineplots that can are generated, twoway_lineplot() and twoway_lineplotf(). The first is a connected scatterplot of a y variable observed over a time period. This allows us to simply track the progression of a variable over time. The second lineplot is used for facetting by the specific characteristic of the objective variable. The plot creates multiple lines in each characteristic, which helps identify any possibe trends in the data within each subgroup and characteristic. Both lineplots shows a basic summary of the statistical progression of the variable of interest.

```{r, eval=TRUE}
#source('/Users/Benjamin Hsu/Desktop/weightprog/R/twoway_lineplot.R')
twl <- twoway_lineplot(hello, dd, hello$Weight, "Weight (kg)")
twl
twl2 <- twoway_lineplotf(hello, xname = "Distance", yname = "Deep_Sleep",
                 bycolor = "Class", bywrap = "Day", 
                 "Distance (km)", "Deep Sleep (%)")
twl2
```

The lineplot for the data used simply shows the progression of the individual's weight over time. We see a rather constant fluctuation in the weight, between the range of approximately 79 to 82 kilograms. The overall trend of the individual's weight seems to be increasing over time. For the future, additional lines will be considered once more data is provided, which will allow for a more accurate re-standardization of the added variable. 

Meanwhile, the second lineplot is facetted by the day of the week, and produces a lineplot for each of the subgroups of the objective variable (that is: loss, gain, and maintain). Each day will present a lineplot of the trend between the x and y variable amongst the subgroup. Specifically, we look at the relationship bewteen distance walked and the percent of deep sleep per day, based on weight changes. So far, we see that from Monday to Thursday, there seems to be only losses in weight, especially with higher amounts of distance walked, but an inconsistent deep sleep percentage. Meanwhile, for Friday, Saturdays, and Sundays, there are only gains in weight, with a substantially lower distance walked on weekends, but a moderate consistency in deep sleep percentages. This lineplot by facetting the objective variable allows for a specific observation of each day's progress of weight changes, and how this progression changes with relation to distance and deep sleep percentage. Though there does seem like a preliminary pattern exists amongst the day of the week and weight changes, it will be interesting to see such weight fluctuations as more data is collected. 

### K-Means Clustering 

The k-means clustering allows for us to find groups that have not been explicitly defined in the data, specifically through two variables of interest. The function creates k centroids, allowing for k clusters to be created, while plotting all these different k-means clusters to allow for a decision on how many clusters to use. In addition, this allows for a confirmation of whether or not the objective variables' subgroups really have a cluster. Though this is a less explicit way of answering whether there is a relationship between two variables according to the objective variable, it allows us to observe almost all possibilities, from small to large amounts of clusters to confirm previous findings. (Note: this k-means is modified from the internet)

```{r}
twoway_kmeans(hello$Distance, hello$Deep_Sleep, 5, 
              "Distance (km)", "Deep Sleep (%)", "Cluster(s) by Color")
```

To further see if an individual's weight changes is affected by the speculation of a relationship between distance walked and percent in deep sleep, the function can confirm how these weight changes are clustered. Theoretically, we would say that higher activity levels might induce a more tired state subsequently higher percentage of deep sleep, which can then split into the subgroups of our objective variable. For gains in weight, we would speculate shorter distance (low activity), and losses in weight with longer distance (high activity), which would mean that for each subgroup, there should be a cluster. 

Ideally, we would only need three clusters, however in the function, we do not see any clusters with a consistent subgroup, since the class (gain/loss/maintain) in each cluster seem to vary. When we do look at the three clusters created, there is a little bit of everything, which may improve as more data is collected. Specifically we see the the middle cluster consists of primary losses, with distance varying, but deep sleep percentage between 50 to 60 percent. The cluster at the top seem to consist of primarily gain, but with plenty of other classes as well. When we observe two clusters only, the bottom of the two clusters seem to be primarily defined by the subgroup for loses in weight with relative precision, and the top cluster for gain with lack of precision. 

While there will always be mis-classified data, the top cluster does not show much consistency in our data, which means that we cannot generalize much about subgroups gain and maintain in weight. However, we do see that losses in weight tend to be classified together with relative consistency with distances from 0 to 8 km and deep sleep percentage from 40 to 65 percent. 

### Linear Discriminant Analysis

The linear discriminant analysis (LDA) allows a more definitive pattern recognition method in comparison to cluster analysis. This type of machine learning focuses on finding a linear combination of features that help separate the groups as far as possible. In addition, linear discriminant analysis might be a better way compared to that of clustered analysis because instead of determining a pattern for grouping certain variables, LDA allows us to utilize the property that the membership to each classification is established already. To use the linear discriminant analysis, the underlying assumption here is that the data is normally distributed, and each of the subgroups have equivalent variances. 

For the package data, the goal of using linear discriminant analysis was to find a linear combination for the selected variables that will provide the largest distinction from one group to the next. The variables used to provide the best separation for the class subgroups (gain/loss/maintain) included distance, time asleep, and percentage in deep and light sleep. For each of the two discriminant functions, a histogram will be used to provide visualization of each class' separation. Along with the histogram, a scatterplot of the first and second discriminant function's values for the classes will be provided. Both the histograms and scatterplots will provide visualizations to pinpoint the presence of any characteristic difference for each class.  

```{r, messages=FALSE}
library(broom)
```

```{r}
twoway_lda(hello$Class, hello$Distance, hello$Time_Asleep,
           hello$Deep_Sleep, hello$Light_Sleep, hello, hello$Class)
```

For the first discriminant function, we speculate that the maintain class may have some separation from the loss class. To better see if there is such discrepancies, we take a look at the second discriminant function, which refutes this statement. Though the loss group does seem to be in a small class of its own, it does not seem to be distinctly separate from the other classes. When we continue and take a look at the scatterplot of the two discriminant functions, we observe that the first discriminant function does indeed have a moderate separation between the maintain and loss group along the x axis. However, for the second discriminant function, it is of the contrary, as none of the groups seem to be separate from one another. Though we do not have much conclusive evidence, the linear discriminant analysis has helped narrow down the possibility that there may exist some type of separation between the loss and maintain group with regards to the characteristics used in distance, time asleep, and percent in deep and light sleep. 

## Results

Since our main goal is to see if there seems to be an explanation for the marginal gain, loss and maintain in weight with respect to the variables reflecting activity and sleep levels, we will summarize the results obtained from above. We begin with some basic summarization graphics: the strip-plot illustrates that the activity level on weekends tend to be significantly lower than weekdays. Meanwhile, the lineplot also illustrates that there tends to be a more prevalent gain in weight on the weekends. Both of these visualizations only allow simple summarization, but no significant advances in answering our question.

To answer our question of interest, we look at the two-way scatter along with cluster and linear discriminant analysis. From our two way scatter feature, we see a randomized trend for the different subgroups for the objective variable. There does not seem to be any specific values of deep sleep and distance walked that seem produce a prevalent pattern for changes in weight for both the size and color utilized. We proceed to the cluster analysis and see that ideally we would need three clusters for each of the subgroups in our class, but this does not seem to provide much distinction between each group. Instead, it seems like such division in the cluster provides an arbitrary clustering that will not help identify specific traits of deep sleep and distance that chracterize the subgroups. To help with maximizing the separation between each group, we resort to the linear discriminant analysis. This allows for a more definitive pattern recognition method based on finding an optimal linear combination that will separate each subgroup. When we look at the histogram for both linear combinations, there does not seem to be any distinction between the groups as they are randomly dispersed with overlapping areas. By plotting the linear combinations, we also see that such subgroups seem to be randomly dispersed, without any distinct pattern recognized. Thus, we conclude that through our visualizations, we are convinced that there does not seem to be any specific values of deep sleep and distance amongst the different subgroups for the marginal change in weight. 

## Limitations and Future Analysis



With a relatively small sample size from the data collected over time in the package at n observations, we can undoubtedly get a clearer picture of the trends with data covering a longer period of time. In addition, we observe that the data is not necessarily representative of our population of interest, given that it is the data from one individual. Therefore, we are limited to any statistical inference that applies to myself only.

There are many different and interesting variables that can be paired together that could potentially suggest an influence on the objective variable of the marginal change in weight. Though we have defined the main variables we will still need to find other variables to explore.

In addition, in the future, we might be interested in further first introducing a visualization that explores the relationship between an activity level and sleep cycle variable, along with the objective variable. This will allow for a better understanding of how it is difficult to deduce a relationship between these variables, which is why we proceeded to use cluster analysis and linear discriminant analysis. We could use a contour plot first in our introduction to display how the objective variable changes in two dimensions with the chosen x and y variables. The greatest problem that using a contour plot is that there is little variation in the weight, and a serious problem in the number of observations. These problems might produce a contour plot that does not provide much introduction to our variables. 

## Session Info
```{r}
sessionInfo()
```
